	<?php
	require ("dbconn.php");
	session_start();
	header('Access-Control-Allow-Origin: *');
	header('Content-Type: application/json');
	$dbconn = dbconn();
	if (!$dbconn) {
	    die("dbconnection failed: " . mysqli_dbconnect_error());
	} 
	else {
		$action = $_GET['action'];
		$data = Array();
		switch ($action) {
			case 'getStudent':
				$sql ="SELECT COUNT(*) As StudentCount FROM Account WHERE userGroupID = 1";
				$result = mysqli_query($dbconn, $sql);
				while ($row = mysqli_fetch_assoc($result)) {
					$data['StudentCount'] = intval($row['StudentCount']);
				}
				echo json_encode($data);
				break;
			case 'getCase':
				$sql ="SELECT COUNT(*) As CaseCount FROM `Case`";
				$result = mysqli_query($dbconn, $sql);
				while ($row = mysqli_fetch_assoc($result)) {
					$data['CaseCount'] = intval($row['CaseCount']);
				}
				echo json_encode($data);
				break;
			case 'getMentor':
				$sql ="SELECT COUNT(*) As MentorCount FROM Account WHERE userGroupID = 2";
				$result = mysqli_query($dbconn, $sql);
				while ($row = mysqli_fetch_assoc($result)) {
					$data['MentorCount'] = intval($row['MentorCount']);
				}
				echo json_encode($data);
				break;
			case 'getAllFunction':
				$userGroupID = $_GET['userGroupID'];
				$sql = "SELECT * FROM UserRole a LEFT JOIN Permission b ON a.userRoleID = b.permissionID WHERE userGroupID = '$userGroupID'";
	            $result = mysqli_query($dbconn, $sql);
				while ($row = mysqli_fetch_assoc($result)) {
					$data[] = array(
						'name' => $row['permissionName'],
						'icon' => $row['permissionIcon'],
						'description' => $row['description'],
						'own' => (bool) $row['own'],
						'userRoleID' => $row['userRoleID']
					);
				}
				echo json_encode($data);
				break;
			case 'update_S':
				$userRoleID = $_GET['userRoleID'];
				$boolean = $_GET['boolean'];
				$sql = "UPDATE UserRole SET own = $boolean WHERE userGroupID = '1' AND userRoleID = '$userRoleID'";
				mysqli_query($dbconn, $sql);
	            break;
			case 'update_M':
				$userRoleID = $_GET['userRoleID'];
				$boolean = $_GET['boolean'];
				$sql = "UPDATE UserRole SET own = $boolean WHERE userGroupID = '2' AND userRoleID = '$userRoleID'";
				mysqli_query($dbconn, $sql);
	            break;
	        case 'getSchoolList':
				$sql ="SELECT * FROM School";
				$result = mysqli_query($dbconn, $sql);
				while ($row = mysqli_fetch_assoc($result)) {
					$data[] = array(
							"schoolName"=>$row['schoolName'],
							"schoolID" => $row['schoolID']
						);
				}
				echo json_encode($data);
				break;
			case 'setSchool':
				$schoolName = $_GET['schoolName'];
				$schoolID = $_GET['schoolID'];
				$sql = "UPDATE School SET schoolName = '$schoolName' WHERE schoolID = '$schoolID'";
				$result = mysqli_query($dbconn, $sql);
				break;
			case 'getProgramList':
				$sql ="SELECT * FROM School";
				$result = mysqli_query($dbconn, $sql);
				while ($row = mysqli_fetch_assoc($result)) {
					$programList =  array();
					$schoolID = $row['schoolID'];
					$sql2 ="SELECT * FROM Program a LEFT JOIN ProgramType b ON a.programTypeID = b.programTypeID WHERE schoolID = '$schoolID'  ";
					$result2 = mysqli_query($dbconn, $sql2);
					while ($row2 = mysqli_fetch_assoc($result2)) {
						$programList[] = array(
								"programID" => $row2['programID'],
								"programName" => $row2['programName'],
								"programTypeID" => $row2['programTypeID'],
								"programTypeName" => $row2['programTypeName']
							);
					}
					$data[] = array(
							"schoolName"=> $row['schoolName'],
							"schoolID" => $row['schoolID'],
							"programList" => $programList
						);
				}
				echo json_encode($data);
				break;
			case 'getProgramTypeList':
				$sql ="SELECT * FROM ProgramType";
				$result = mysqli_query($dbconn, $sql);
				while ($row = mysqli_fetch_assoc($result)) {
					$data[] = array(
							"programTypeID"=> $row['programTypeID'],
							"programTypeName" => $row['programTypeName']
						);
				}
				echo json_encode($data);
				break;
			case 'setProgram':
				$schoolID = $_GET['schoolID'];
				$programID = $_GET['programID'];
				$programName = $_GET['programName'];
				$programTypeID = $_GET['programTypeID'];
				$sql = "UPDATE Program SET programName = '$programName' , programTypeID = '$programTypeID'  WHERE schoolID = '$schoolID' AND programID = '$programID'";
				$result = mysqli_query($dbconn, $sql);
			case 'getEventList':
				$sql = "SELECT * FROM Event";
				$result = mysqli_query($dbconn, $sql);
				while ($row = mysqli_fetch_assoc($result)) {
					$eventDate = strtotime($row['eventDate']);
					$eventDate = date('Y-m-d',$eventDate);
					$data[] = array(
							'eventID' => $row['eventID'],
							'eventName' => $row['eventName'],
							'eventDetail' => $row['eventDetail'],
							'eventDate' => $eventDate
						);
				};
				echo json_encode($data);
			break;
			case 'removeEvent':
				$eventID = $_GET['eventID'];
				$sql = "DELETE FROM Event WHERE eventID = '$eventID'";
				$result = mysqli_query($dbconn, $sql);
				break;
			case 'setEvent':
				$eventID = $_GET['eventID'];
				$eventName = $_GET['eventName'];
				$eventDetail = $_GET['eventDetail'];
				$eventDate = $_GET['eventDate'];
				$sql = "UPDATE Event SET eventName = '$eventName' ,eventDetail = '$eventDetail' ,eventDate = '$eventDate'  WHERE eventID = '$eventID'";
				$result = mysqli_query($dbconn, $sql);
				break;
		}
		mysqli_close($dbconn);
	}
	?>
